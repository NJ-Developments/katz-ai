// ===========================================
// Prisma Schema for KatzAI
// ===========================================

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearch", "postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [pgvector(map: "vector"), pg_trgm, unaccent]
}

// ============ STORES (TENANTS) ============
model Store {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  address   String?
  policies  Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users         User[]
  inventoryItems InventoryItem[]
  conversations Conversation[]
  carts         Cart[]

  @@index([slug])
}

// ============ USERS ============
model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  name         String
  role         UserRole @default(EMPLOYEE)
  storeId      String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  store         Store          @relation(fields: [storeId], references: [id], onDelete: Cascade)
  conversations Conversation[]
  carts         Cart[]

  @@index([email])
  @@index([storeId])
}

enum UserRole {
  EMPLOYEE
  MANAGER
  ADMIN
}

// ============ INVENTORY ============
model InventoryItem {
  id          String   @id @default(cuid())
  sku         String
  name        String
  description String
  category    String
  price       Decimal  @db.Decimal(10, 2)
  stock       Int      @default(0)
  aisle       String
  bin         String?
  tags        String[] @default([])
  attributes  Json     @default("{}")
  storeId     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Optional: Vector embedding for semantic search
  // embedding Unsupported("vector(1536)")?

  // Relations
  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@unique([sku, storeId])
  @@index([storeId])
  @@index([category])
  @@index([name])
  @@index([tags])
}

// ============ CONVERSATIONS ============
model Conversation {
  id              String   @id @default(cuid())
  storeId         String
  userId          String
  messages        Json     @default("[]")
  recommendedSkus String[] @default([])
  metadata        Json     @default("{}")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  store Store  @relation(fields: [storeId], references: [id], onDelete: Cascade)
  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  carts Cart[]

  @@index([storeId])
  @@index([userId])
  @@index([createdAt])
}

// ============ CARTS ============
model Cart {
  id             String   @id @default(cuid())
  items          Json     @default("[]")
  storeId        String
  userId         String
  conversationId String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  store        Store         @relation(fields: [storeId], references: [id], onDelete: Cascade)
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversation Conversation? @relation(fields: [conversationId], references: [id])

  @@index([storeId])
  @@index([userId])
}

// ============ CONVERSATION LOGS (Analytics) ============
model ConversationLog {
  id              String   @id @default(cuid())
  conversationId  String
  storeId         String
  userId          String
  userMessage     String
  assistantMessage String
  recommendedSkus String[] @default([])
  latencyMs       Int
  intent          String?
  constraints     Json     @default("{}")
  createdAt       DateTime @default(now())

  @@index([storeId])
  @@index([createdAt])
  @@index([intent])
}
