// ===========================================
// Prisma Schema for KatzAI (SQLite - No Setup!)
// ===========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============ STORES (TENANTS) ============
model Store {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  address   String?
  policies  String   @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users          User[]
  inventoryItems InventoryItem[]
  conversations  Conversation[]
  carts          Cart[]
}

// ============ USERS ============
model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  name         String
  role         String   @default("EMPLOYEE")
  storeId      String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  store         Store          @relation(fields: [storeId], references: [id], onDelete: Cascade)
  conversations Conversation[]
  carts         Cart[]
}

// ============ INVENTORY ============
model InventoryItem {
  id          String   @id @default(cuid())
  sku         String
  name        String
  description String
  category    String
  price       Decimal
  stock       Int      @default(0)
  aisle       String
  bin         String?
  tags        String   @default("[]")
  attributes  String   @default("{}")
  storeId     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@unique([sku, storeId])
}

// ============ CONVERSATIONS ============
model Conversation {
  id              String   @id @default(cuid())
  storeId         String
  userId          String
  messages        String   @default("[]")
  recommendedSkus String   @default("[]")
  metadata        String   @default("{}")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  store Store  @relation(fields: [storeId], references: [id], onDelete: Cascade)
  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  carts Cart[]
}

// ============ CARTS ============
model Cart {
  id             String   @id @default(cuid())
  items          String   @default("[]")
  storeId        String
  userId         String
  conversationId String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  store        Store         @relation(fields: [storeId], references: [id], onDelete: Cascade)
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversation Conversation? @relation(fields: [conversationId], references: [id])
}

// ============ CONVERSATION LOGS (Analytics) ============
model ConversationLog {
  id               String   @id @default(cuid())
  conversationId   String
  storeId          String
  userId           String
  userMessage      String
  assistantMessage String
  recommendedSkus  String   @default("[]")
  latencyMs        Int
  intent           String?
  constraints      String   @default("{}")
  createdAt        DateTime @default(now())
}
